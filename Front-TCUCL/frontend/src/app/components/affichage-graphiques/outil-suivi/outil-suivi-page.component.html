<!-- outil-suivi-page.component.html -->
<div class="container">
  <header class="header">
      <button class="back-btn" (click)="goHome()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M15 18l-6-6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Retour
      </button>
      <h2 class="page-title">Suivi des évolutions du bilan carbone</h2>
  </header>

    <div class="filters">
      <label for="etablissement">Établissement :</label>
      <select id="etablissement" [(ngModel)]="selectedEtablissement" (ngModelChange)="onEtablissementChange()">
        <option *ngFor="let e of etablissements" [value]="e">{{ e }}</option>
      </select>
    </div>

    <!-- ============================ -->
    <!-- Graphique 1: Évolution usager -->
    <!-- TODO BACKEND: lister les années et séries via API -->
    <!-- ============================ -->
  <div class="card">
      <div class="card-actions">
        <button class="icon-btn" (click)="toggleMenu('g1')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Télécharger
        </button>
        <div class="dropdown" *ngIf="cardMenuOpen['g1']">
          <button (click)="downloadPdfFor('g1', svgG1)">Télécharger le graphique (PDF)</button>
          <button (click)="downloadCsvFor('g1')">Télécharger les données (CSV)</button>
        </div>
      </div>
    <h3>Évolution des émissions (kgCO₂e/usager)</h3>
  <div style="font-size:12px; color:#666; margin-bottom:8px;">Établissement : <strong>{{ selectedEtablissement }}</strong></div>

      <div class="chart-scroll">
        <!-- Légende -->
        <div class="legend" style="margin: 4px 0 8px;">
          <span class="legend-item"><span class="legend-color" style="background:#999"></span>Base (objectif / min)</span>
          <span class="legend-item"><span class="legend-color" style="background:#e74c3c"></span>Dépassement (> objectif)</span>
          <span class="legend-item"><span class="legend-color" style="background:#27ae60"></span>Inférieur à l'objectif</span>
        </div>
        <div class="chart-center">
          <svg #svgG1 [attr.width]="svgWidth" [attr.height]="firstChartHeight">
      <ng-container *ngFor="let year of years; let i = index">
              <g (mouseenter)="onEnterBar(i)" (mouseleave)="onLeaveBar()" (mousemove)="onMoveBar($event, i)">
                <!-- Partie grise : objectif (si réalisé absent) ou min(obj,rea) -->
        <rect
                  *ngIf="getYearObj(i) !== null || getYearRea(i) !== null"
                  [attr.x]="getX(i)"
                  [attr.y]="getY(baseValue(i))"
                  [attr.width]="barWidth"
                  [attr.height]="getHeight(baseValue(i))"
          fill="#999"
                  [ngClass]="{ 'bar-animated': true, 'bar-highlight': hoverBar === i }"
        ></rect>

                <!-- Partie rouge : dépassement au-dessus de l'objectif (si les deux existent) -->
        <rect
                  *ngIf="greater(i)"
                  [attr.x]="getX(i)"
                  [attr.y]="getY(getYearRea(i)!)"
                  [attr.width]="barWidth"
                  [attr.height]="getHeight(getYearRea(i)! - getYearObj(i)!)"
          fill="#e74c3c"
                  [ngClass]="{ 'bar-animated': true, 'bar-highlight': hoverBar === i }"
        ></rect>

                <!-- Partie verte : émissions plus faibles que l'objectif (si les deux existent) -->
        <rect
                  *ngIf="less(i)"
                  [attr.x]="getX(i)"
                  [attr.y]="getY(getYearObj(i)!)"
                  [attr.width]="barWidth"
                  [attr.height]="getHeight(getYearObj(i)! - getYearRea(i)!)"
          fill="#27ae60"
                  [ngClass]="{ 'bar-animated': true, 'bar-highlight': hoverBar === i }"
        ></rect>

        <!-- Année -->
        <text
                  [attr.x]="getX(i) + barWidth/2"
          y="275"
          text-anchor="middle"
          font-size="11"
        >
          {{ year }}
        </text>

                <!-- Indicateurs référence/cible -->
                <text *ngIf="i === 0"
                  [attr.x]="getX(i) + barWidth/2"
                  y="298"
                  text-anchor="middle"
                  font-size="10"
                  fill="#888"
                  font-style="italic"
                >Année de référence</text>
                <text *ngIf="i === years.length - 1"
                  [attr.x]="getX(i) + barWidth/2"
                  y="298"
                  text-anchor="middle"
                  font-size="10"
                  fill="#888"
                  font-style="italic"
                >Année cible</text>

                <!-- Valeur affichée: réalisé si dispo, sinon objectif; toujours au-dessus du segment le plus haut -->
        <text
                  *ngIf="yearLabelValue(i) !== null && yearTop(i) !== null"
                  [attr.x]="getX(i) + barWidth/2"
                  [attr.y]="getY(yearTop(i)!) - 6"
          text-anchor="middle"
          font-size="10"
        >
                  {{ yearLabelValue(i) }}
        </text>

                <!-- Différence (sécurisée) -->
        <text
                  [attr.x]="getX(i) + barWidth/2"
                  y="288"
          text-anchor="middle"
          font-size="10"
                  [attr.fill]="greater(i) ? '#e74c3c' : (less(i) ? '#27ae60' : '#999')"
        >
                  {{ getYearDiffText(i) }}
        </text>
              </g>
      </ng-container>

      <!-- Axe -->
            <line [attr.x1]="margin" y1="250" [attr.x2]="svgWidth - margin" y2="250" stroke="#ccc"></line>
          </svg>
        </div>
      </div>
    </div>

    <!-- ============================ -->
    <!-- Graphique 2: Global tCO2 -->
    <!-- TODO BACKEND: récupérer les totaux globaux tCO2 par année -->
    <!-- ============================ -->
    <div class="card" style="margin-top:12px;">
      <div class="card-actions">
        <button class="icon-btn" (click)="toggleMenu('g2')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Télécharger
        </button>
        <div class="dropdown" *ngIf="cardMenuOpen['g2']">
          <button (click)="downloadPdfFor('g2', svgG2)">Télécharger le graphique (PDF)</button>
          <button (click)="downloadCsvFor('g2')">Télécharger les données (CSV)</button>
        </div>
      </div>
  <h3>Évolution des émissions globales (tCO₂)</h3>
  <div style="font-size:12px; color:#666; margin-bottom:8px;">Établissement : <strong>{{ selectedEtablissement }}</strong></div>
      <div class="chart-scroll">
        <!-- Légende -->
        <div class="legend" style="margin: 4px 0 8px;">
          <span class="legend-item"><span class="legend-color" style="background:#329dd5"></span>Émissions annuelles (tCO₂)</span>
          <span class="legend-item"><span class="legend-color" style="background:#999"></span>Ligne de référence (année de ref.)</span>
        </div>
        <div class="chart-center">
          <svg #svgG2 [attr.width]="svgWidth" [attr.height]="firstChartHeight">
            <ng-container *ngFor="let year of years; let i = index">
              <g (mouseenter)="onEnterGlobal(i)" (mouseleave)="onLeaveGlobal()" (mousemove)="onMoveGlobal($event, i)">
                <!-- Barre simple -->
                <rect
                  [attr.x]="getX(i)"
                  [attr.y]="getGlobalY(globalTotals[i])"
                  [attr.width]="barWidth"
                  [attr.height]="getGlobalHeight(globalTotals[i])"
                  fill="#329dd5"
                  [ngClass]="{ 'bar-animated': true, 'bar-highlight': hoverGlobalIndex === i }"
                ></rect>

                <!-- Année -->
                <text
                  [attr.x]="getX(i) + barWidth/2"
                  y="275"
                  text-anchor="middle"
                  font-size="11"
                >
                  {{ year }}
                </text>

                <!-- Indicateurs référence/cible dynamiques -->
                <text *ngIf="i === 0"
                  [attr.x]="getX(i) + barWidth/2"
                  y="298"
                  text-anchor="middle"
                  font-size="10"
                  fill="#888"
                  font-style="italic"
                >Année de référence</text>
                <text *ngIf="i === years.length - 1"
                  [attr.x]="getX(i) + barWidth/2"
                  y="298"
                  text-anchor="middle"
                  font-size="10"
                  fill="#888"
                  font-style="italic"
                >Année cible</text>

                <!-- Pourcentage vs référence -->
                <text
                  [attr.x]="getX(i) + barWidth/2"
                  y="288"
                  text-anchor="middle"
                  font-size="10"
                  [attr.fill]="getGlobalDiffColor(i)"
                >
                  {{ getGlobalDiffPct(i) }}
                </text>

                <!-- Valeur au-dessus de la barre (tCO2) -->
                <text
                  [attr.x]="getX(i) + barWidth/2"
                  [attr.y]="getGlobalY(globalTotals[i]) - 6"
                  text-anchor="middle"
                  font-size="10"
                >
                  {{ isValidGlobal(globalTotals[i]) ? globalTotals[i] : '-' }}
                </text>
              </g>
            </ng-container>

            <!-- Ligne horizontale au niveau de l'année de référence (base) -->
            <line [attr.x1]="margin" [attr.y1]="getGlobalY(globalRef)" [attr.x2]="svgWidth - margin" [attr.y2]="getGlobalY(globalRef)" stroke="#999" stroke-dasharray="4 4"></line>

            <!-- Axe -->
            <line [attr.x1]="margin" y1="250" [attr.x2]="svgWidth - margin" y2="250" stroke="#ccc"></line>
          </svg>
        </div>
      </div>
    </div>

    <!-- Séparateur stylé entre blocs -->
    <div class="charts-separator"><span class="label">Synthèse / Détails</span></div>

    <div class="card" style="margin-top:16px;">
      <div class="card-actions">
        <button class="icon-btn" (click)="toggleMenu('g3')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Télécharger
        </button>
        <div class="dropdown" *ngIf="cardMenuOpen['g3']">
          <button (click)="downloadPdfFor('g3', null)">Télécharger le graphique (PDF)</button>
          <button (click)="downloadCsvFor('g3')">Télécharger les données (CSV)</button>
        </div>
      </div>
      <h3>Suivi des émissions par poste (kgCO₂e/usager)</h3>
      <div style="font-size:12px; color:#666; margin-bottom:8px;">Établissement : <strong>{{ selectedEtablissement }}</strong></div>

      <div class="filters" style="margin-bottom:8px;">
        <label for="anneePostes">Année :</label>
        <select id="anneePostes" [(ngModel)]="selectedYearForPostes">
          <option *ngFor="let y of years" [value]="y">{{ y }}</option>
        </select>
      </div>

      <div class="legend">
        <span class="legend-item"><span class="legend-color objectif"></span>Objectif (Année {{ selectedYearForPostes }})</span>
        <span class="legend-item"><span class="legend-color realise"></span>Réalisé (Année {{ selectedYearForPostes }})</span>
      </div>

      <div class="chart-center">
  <svg #svgG3 data-chart="g3" *ngIf="selectedYearForPostes !== null && postesObjectifParAn[selectedYearForPostes] && postesRealiseParAn[selectedYearForPostes]"
             [attr.width]="postesHChartWidth" [attr.height]="postesHChartHeight">
          <!-- Grille légère -->
          <g>
            <ng-container *ngFor="let tick of [0,0.25,0.5,0.75,1]; let ti = index">
              <line [attr.x1]="postesLeftLabelWidth + tick * postesUsableWidth" y1="0"
                    [attr.x2]="postesLeftLabelWidth + tick * postesUsableWidth" [attr.y2]="postesHChartHeight"
                    stroke="#eee" stroke-dasharray="2 3" />
            </ng-container>
          </g>

          <!-- Lignes par poste -->
          <ng-container *ngFor="let poste of postes; let i = index">
            <!-- Séparateur entre lignes (sauf avant la première) -->
            <line *ngIf="i > 0"
                  [attr.x1]="0"
                  [attr.y1]="getPostGroupY(i) - (postesRowHeight/2)"
                  [attr.x2]="postesHChartWidth"
                  [attr.y2]="getPostGroupY(i) - (postesRowHeight/2)"
                  stroke="#eee" stroke-width="1" />

            <!-- Label à gauche -->
            <text [attr.x]="postesLeftLabelWidth - 8" [attr.y]="getPostGroupY(i) + 4" text-anchor="end" font-size="12">{{ poste }}</text>

            <!-- Barre Objectif (au-dessus) -->
            <rect
              [attr.x]="getPostBarX()"
              [attr.y]="getPostObjBarY(i)"
              [attr.width]="getPostBarWidth(postesObjectifParAn[selectedYearForPostes][i] || 0, selectedYearForPostes)"
              [attr.height]="postesBarHeight"
              fill="#329dd5"
              class="bar-animated"
            ></rect>

            <!-- Barre Réalisé (en-dessous) -->
            <rect
              [attr.x]="getPostBarX()"
              [attr.y]="getPostReaBarY(i)"
              [attr.width]="getPostBarWidth(postesRealiseParAn[selectedYearForPostes][i] || 0, selectedYearForPostes)"
              [attr.height]="postesBarHeight"
              fill="#f39c12"
              class="bar-animated"
            ></rect>

            <!-- Valeurs au bout des barres (capées) -->
            <text
              [attr.x]="getValueLabelX(postesObjectifParAn[selectedYearForPostes][i] || 0, selectedYearForPostes)"
              [attr.y]="getPostObjBarY(i) + postesBarHeight - 2"
              font-size="11" fill="#329dd5">
              {{ (postesObjectifParAn[selectedYearForPostes][i] > 0 ? postesObjectifParAn[selectedYearForPostes][i] : '-') }}
            </text>
            <text
              [attr.x]="getValueLabelX(postesRealiseParAn[selectedYearForPostes][i] || 0, selectedYearForPostes)"
              [attr.y]="getPostReaBarY(i) + postesBarHeight - 2"
              font-size="11" fill="#f39c12">
              {{ (postesRealiseParAn[selectedYearForPostes][i] > 0 ? postesRealiseParAn[selectedYearForPostes][i] : '-') }}
            </text>

            <!-- Différence à droite (dans la marge droite) -->
            <text
              [attr.x]="postesHChartWidth - 8"
              [attr.y]="getPostGroupY(i) + 4"
              text-anchor="end"
              font-size="12"
              [attr.fill]="getPostDiffColor(postesObjectifParAn[selectedYearForPostes][i], postesRealiseParAn[selectedYearForPostes][i])">
              {{ getPostDiffPct(postesObjectifParAn[selectedYearForPostes][i], postesRealiseParAn[selectedYearForPostes][i]) }}
            </text>
          </ng-container>
        </svg>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-actions">
        <button class="icon-btn" (click)="toggleMenu('g4')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Télécharger
        </button>
        <div class="dropdown" *ngIf="cardMenuOpen['g4']">
          <button (click)="downloadPdfFor('g4', svgG4)">Télécharger le graphique (PDF)</button>
          <button (click)="downloadCsvFor('g4')">Télécharger les données (CSV)</button>
        </div>
      </div>
    <h3>Comparaison des émissions par poste (kgCO₂e/utilisateur)</h3>
    <div style="font-size:12px; color:#666; margin-bottom:8px;">Établissement : <strong>{{ selectedEtablissement }}</strong></div>

    <div class="filters" style="margin-bottom:8px;">
        <label>Sélectionner les années à comparer :</label>
        <div style="position: relative; display: inline-block;">
          <button class="year-select-btn" (click)="toggleCompareMenu(); $event.stopPropagation()">
            {{ compareYears.length }} année{{ compareYears.length > 1 ? 's' : '' }} sélectionnée{{ compareYears.length > 1 ? 's' : '' }}
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 9l6 6 6-6" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="year-select-dropdown" *ngIf="compareMenuOpen" (click)="$event.stopPropagation()">
            <ng-container *ngFor="let y of years">
              <label class="year-checkbox-label" [ngClass]="{ 'selected': isYearSelected(y) }">
                <input type="checkbox" [checked]="isYearSelected(y)" (change)="toggleCompareYear(y)" />
                <span class="year-checkbox-indicator" [style.background-color]="getYearColor(y)"></span>
                <span>Année {{ y }}</span>
              </label>
            </ng-container>
          </div>
        </div>

      <label style="margin-left:12px;">Sélectionner les postes :</label>
      <div style="position: relative; display: inline-block;">
        <button class="year-select-btn" (click)="toggleComp4PostesMenu(); $event.stopPropagation()">
          {{ comp4VisiblePostesCount }} poste{{ comp4VisiblePostesCount > 1 ? 's' : '' }}
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 9l6 6 6-6" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="year-select-dropdown" *ngIf="comp4PostesMenuOpen" (click)="$event.stopPropagation()">
          <label class="year-checkbox-label" [ngClass]="{ 'selected': selectedPosteIndexes.length === 0 }">
            <input type="checkbox" [checked]="selectedPosteIndexes.length === 0" (change)="selectAllPostes()" />
            <span class="year-checkbox-indicator" style="background:#666"></span>
            <span><strong>Tous les postes</strong></span>
          </label>
          <ng-container *ngFor="let p of postes; let pi = index">
            <label class="year-checkbox-label" [ngClass]="{ 'selected': isPosteSelected(pi) }">
              <input type="checkbox" [checked]="isPosteSelected(pi)" (change)="togglePoste(pi)" />
              <span class="year-checkbox-indicator" [style.background-color]="getPosteColor(p)"></span>
              <span>{{ p }}</span>
            </label>
          </ng-container>
        </div>
      </div>
      </div>

    <div class="legend">
      <span class="legend-item" *ngFor="let y of compareYears">
        <span class="legend-color realise" [style.background-color]="getYearColor(y)"></span>
        Année {{ y }}
      </span>
      <span style="margin-left:auto; display:inline-flex; align-items:center; gap:8px;">
        <label for="pctMode" style="font-size:12px; color:#555;">Référence % :</label>
        <select id="pctMode" [(ngModel)]="comp4PercentMode" style="padding:4px 6px; border:1px solid #d0d7de; border-radius:6px; font-size:12px;">
          <option value="vs_mean">Moyenne (sélection)</option>
          <option value="vs_first">Première année</option>
        </select>
      </span>
    </div>

      <div class="chart-scroll">
      <svg #svgG4 [attr.width]="comp4ChartWidth" [attr.height]="comp4ChartHeight">
          <!-- Grille verticale légère -->
          <g>
            <ng-container *ngFor="let tick of [0,0.25,0.5,0.75,1]">
              <line [attr.x1]="comp4BarStartX + tick * comp4UsableWidth" y1="0"
                    [attr.x2]="comp4BarStartX + tick * comp4UsableWidth" [attr.y2]="comp4ChartHeight"
                    stroke="#f0f0f0" stroke-dasharray="2 2" />
            </ng-container>
          </g>

        <ng-container *ngFor="let posteIdx of comp4VisiblePosteIndexes; let visibleIdx = index">
          <ng-container *ngIf="postes[posteIdx] as poste">
            <!-- Séparateur entre postes -->
            <line *ngIf="visibleIdx > 0"
                  [attr.x1]="0" [attr.y1]="comp4PosteY(visibleIdx) - comp4PosteGap/2"
                  [attr.x2]="comp4ChartWidth" [attr.y2]="comp4PosteY(visibleIdx) - comp4PosteGap/2"
                  stroke="#e8e8e8" stroke-width="1" />

            <!-- Label du poste (au centre vertical du groupe) -->
            <text [attr.x]="comp4LeftLabelWidth - 10"
                  [attr.y]="comp4PosteY(visibleIdx) + comp4PosteHeight/2 + 4"
                  text-anchor="end" font-size="12" fill="#333">
              {{ poste }}
            </text>

            <!-- Barres pour chaque année sélectionnée -->
            <ng-container *ngFor="let year of compareYears; let yearIdx = index">
              <!-- Barre -->
              <rect [attr.x]="comp4BarStartX"
                    [attr.y]="comp4BarY(visibleIdx, yearIdx)"
                    [attr.width]="comp4BarWidth(postesRealiseParAn[year][posteIdx] || 0)"
                    [attr.height]="comp4BarHeight"
                    [attr.fill]="getYearColor(year)"
                    class="bar-animated"
                    rx="2"></rect>
              
              <!-- Valeur au bout de la barre -->
              <text [attr.x]="comp4ValueX(postesRealiseParAn[year][posteIdx] || 0)"
                    [attr.y]="comp4BarY(visibleIdx, yearIdx) + comp4BarHeight/2 + 4"
                    font-size="11"
                    [attr.fill]="getYearColor(year)"
                    dominant-baseline="middle">
                {{ (postesRealiseParAn[year][posteIdx] && postesRealiseParAn[year][posteIdx] > 0) ? postesRealiseParAn[year][posteIdx] : '-' }}
              </text>
            </ng-container>

            <!-- Pourcentage de variation (selon le mode choisi) à droite -->
            <text *ngIf="compareYears.length > 1"
                  [attr.x]="comp4ChartWidth - 8"
                  [attr.y]="comp4PosteY(visibleIdx) + comp4PosteHeight/2 + 4"
                  text-anchor="end"
                  font-size="11"
                  [attr.fill]="comp4DiffColor(compareYears[compareYears.length - 1], posteIdx)">
              {{ comp4DiffPct(compareYears[compareYears.length - 1], posteIdx) }}
            </text>
          </ng-container>
        </ng-container>
    </svg>
      </div>
    </div>

    <!-- Séparateur stylé entre graphiques 4 et 5 -->
    <div class="charts-separator" style="margin-top:24px;"><span class="label">Détails / Suivi</span></div>

    <!-- ============================ -->
    <!-- Graphique 5: Suivi des indicateurs -->
    <!-- ============================ -->
    <div class="card" style="margin-top:16px;">
      <div class="card-actions">
        <button class="icon-btn" (click)="toggleMenu('g5')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Télécharger
        </button>
        <div class="dropdown" *ngIf="cardMenuOpen['g5']">
          <button (click)="downloadPdfFor('g5', tableG5)">Télécharger le graphique (PDF)</button>
          <button (click)="downloadCsvFor('g5')">Télécharger les données (CSV)</button>
        </div>
      </div>
      <h3>Suivi des indicateurs</h3>
      <div style="font-size:12px; color:#666; margin-bottom:8px;">Établissement : <strong>{{ selectedEtablissement }}</strong></div>

      <div class="filters" style="margin-bottom:8px;">
        <label>Sélectionner les années :</label>
        <div style="position: relative; display: inline-block;">
          <button class="year-select-btn" (click)="toggleIndicateursYearsMenu(); $event.stopPropagation()">
            {{ indicateursSelectedYears.length }} année{{ indicateursSelectedYears.length > 1 ? 's' : '' }}
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 9l6 6 6-6" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="year-select-dropdown" *ngIf="indicateursYearsMenuOpen" (click)="$event.stopPropagation()">
            <ng-container *ngFor="let y of years">
              <label class="year-checkbox-label" [ngClass]="{ 'selected': isIndicateurYearSelected(y) }"
                     [style.background-color]="isIndicateurYearSelected(y) ? '#e3f2fd' : 'transparent'"
                     style="transition: background-color 0.2s;">
                <input type="checkbox" [checked]="isIndicateurYearSelected(y)" (change)="toggleIndicateurYear(y)" />
                <span class="year-checkbox-indicator" [style.background-color]="getIndicateurYearColor(y)"></span>
                <span>Année {{ y }}</span>
              </label>
            </ng-container>
          </div>
        </div>

        <label style="margin-left:12px;">Sélectionner les indicateurs :</label>
        <div style="position: relative; display: inline-block;">
          <button class="year-select-btn" (click)="toggleIndicateursKeysMenu(); $event.stopPropagation()">
            {{ getSelectedIndicateursCount() }} indicateur{{ getSelectedIndicateursCount() > 1 ? 's' : '' }}
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 9l6 6 6-6" stroke="#24292f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="year-select-dropdown" *ngIf="indicateursKeysMenuOpen" (click)="$event.stopPropagation()" style="max-height:400px;">
            <label class="year-checkbox-label" [ngClass]="{ 'selected': indicateursSelectedCategories.length === 0 }"
                   [style.background-color]="indicateursSelectedCategories.length === 0 ? '#e3f2fd' : 'transparent'"
                   style="transition: background-color 0.2s;">
              <input type="checkbox" [checked]="indicateursSelectedCategories.length === 0" (change)="selectAllIndicateurs()" />
              <span class="year-checkbox-indicator" style="background:#666"></span>
              <span><strong>Tous les indicateurs</strong></span>
            </label>
            <ng-container *ngFor="let cat of indicateursCategories">
              <label class="year-checkbox-label" [ngClass]="{ 'selected': isCategorySelected(cat.nom) }" 
                     [style.background-color]="isCategorySelected(cat.nom) ? '#e3f2fd' : '#f8f9fa'"
                     style="font-weight:600; margin-top:4px; transition: background-color 0.2s;">
                <input type="checkbox" [checked]="isCategorySelected(cat.nom)" (change)="toggleCategory(cat.nom)" />
                <span class="year-checkbox-indicator" [style.background-color]="getPosteColor(cat.nom)"></span>
                <span><strong>{{ cat.nom }}</strong></span>
              </label>
            </ng-container>
          </div>
        </div>
      </div>

      <div class="chart-scroll">
        <table #tableG5 style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #dee2e6;">
              <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Catégorie</th>
              <th style="padding:10px; text-align:left; border:1px solid #dee2e6;">Indicateur</th>
              <th style="padding:10px; text-align:center; border:1px solid #dee2e6;">Unité</th>
              <th *ngFor="let y of indicateursSelectedYears" style="padding:10px; text-align:center; border:1px solid #dee2e6;">{{ y }}</th>
              <th *ngIf="indicateursSelectedYears.length > 1" style="padding:10px; text-align:center; border:1px solid #dee2e6;">Diff %</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let item of getVisibleIndicateurs(); let i = index">
              <tr *ngIf="i === 0 || getVisibleIndicateurs()[i-1].categorie !== item.categorie" 
                  style="background:#f8f9fa; font-weight:600;">
                <td style="padding:8px; border:1px solid #dee2e6;" [attr.colspan]="indicateursSelectedYears.length + (indicateursSelectedYears.length > 1 ? 4 : 3)">
                  {{ item.categorie }}
                </td>
              </tr>
              <tr>
                <td style="padding:8px; border:1px solid #dee2e6;"></td>
                <td style="padding:8px; border:1px solid #dee2e6;">{{ item.indicateur.nom }}</td>
                <td style="padding:8px; text-align:center; border:1px solid #dee2e6;">{{ item.indicateur.unite || '-' }}</td>
                <td *ngFor="let y of indicateursSelectedYears" style="padding:8px; text-align:center; border:1px solid #dee2e6;">
                  {{ (indicateursParAn[y] && indicateursParAn[y][item.indicateur.key] !== null && indicateursParAn[y][item.indicateur.key] !== undefined) 
                      ? (typeof indicateursParAn[y][item.indicateur.key] === 'number' 
                          ? (indicateursParAn[y][item.indicateur.key]!.toLocaleString('fr-FR')) 
                          : indicateursParAn[y][item.indicateur.key])
                      : '-' }}
                </td>
                <td *ngIf="indicateursSelectedYears.length > 1" 
                    style="padding:8px; text-align:center; border:1px solid #dee2e6;"
                    [style.color]="getIndicateurDiffColor(indicateursSelectedYears[indicateursSelectedYears.length - 1], item.indicateur.key)">
                  {{ getIndicateurDiffPct(indicateursSelectedYears[indicateursSelectedYears.length - 1], item.indicateur.key) }}
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tooltip HTML overlay pour le graphique 1 -->
    <div *ngIf="hoverBar !== null" class="chart-tooltip" [ngStyle]="{ left: tooltipPageX + 'px', top: (tooltipPageY - 70) + 'px' }">
      <div class="chart-tooltip__title">{{ getTooltipYear() }}</div>
      <div class="chart-tooltip__row">Objectif&nbsp;: <strong>{{ getTooltipObjectif() }}</strong></div>
      <div class="chart-tooltip__row">Réalisé&nbsp;: <strong>{{ getTooltipRealise() }}</strong></div>
    </div>

    <!-- Tooltip HTML overlay pour graphique global -->
    <div *ngIf="hoverGlobalIndex !== null" class="chart-tooltip" [ngStyle]="{ left: tooltipPageX + 'px', top: (tooltipPageY - 70) + 'px' }">
      <div class="chart-tooltip__title">{{ getTooltipYearGlobal() }}</div>
      <div class="chart-tooltip__row">Total (tCO₂)&nbsp;: <strong>{{ getTooltipGlobalTotal() }}</strong></div>
      <div class="chart-tooltip__row">Écart vs réf&nbsp;: <strong>{{ getTooltipGlobalDiff() }}</strong></div>
  </div>
</div>

<div class="page">

  <!-- Barre d'actions en haut -->
  <section class="top-actions">
    <div class="top-actions__group">
      <button class="btn" (click)="exportCSV()">üìÑ CSV</button>
      <button class="btn btn-primary" (click)="exportPDF()">üìò PDF</button>
      <button class="btn btn-secondary" (click)="goHome()">‚Üê Retour</button>
    </div>

    <aside class="wish-card">
      <div class="wish-card__title">Baisse globale entre {{ startYear }} et {{ endYear }}</div>
      <div class="wish-card__value">{{ overallDropBetweenPct | number:'1.0-0' }}%</div>
    </aside>
  </section>

  <!-- Filtres -->
  <section class="filters">
    <div class="filter-card">
      <label>√âtablissement</label>
      <!-- Si superadmin, afficher un menu d√©roulant avec toutes les entit√©s -->
      <select class="select" 
              *ngIf="userService.isSuperAdmin()" 
              [(ngModel)]="selectedEntiteId" 
              (ngModelChange)="onEtablissementChange($event)">
        <option *ngFor="let entite of entites" [value]="entite.id">{{ entite.nom }}</option>
      </select>
      <!-- Si pas superadmin, afficher un input text readonly -->
      <input type="text" 
             *ngIf="!userService.isSuperAdmin()"
             class="select"
             [value]="getSelectedEtablissementName() || userService.entite() || 'Chargement...'"
             [readonly]="true"
             [disabled]="true"
             [class.readonly]="true"
             style="cursor: not-allowed;" />
    </div>

    <div class="filter-card">
      <label>Ann√©e de r√©f√©rence</label>
      <select class="select" 
              [(ngModel)]="startYear" 
              (ngModelChange)="onStartYearSelect($event)"
              [disabled]="!userService.isSuperAdmin()"
              [class.readonly]="!userService.isSuperAdmin()">
        <option *ngFor="let y of allowedYears" [ngValue]="y" [disabled]="y > endYear">{{ y }}</option>
      </select>
    </div>

    <div class="filter-card">
      <label>Ann√©e objectif</label>
      <select class="select" 
              [(ngModel)]="endYear" 
              (ngModelChange)="onEndYearSelect($event)"
              [disabled]="!userService.isSuperAdmin()"
              [class.readonly]="!userService.isSuperAdmin()">
        <option *ngFor="let y of allowedYears" [ngValue]="y" [disabled]="y < startYear">{{ y }}</option>
      </select>
    </div>

    <div class="filter-card filter-card--slider">
      <div class="filter-card__head">
        <label>Baisse globale souhait√©e</label>
        <span class="percent-chip">{{ reduction }}%</span>
      </div>
      <input type="range" 
             min="0" 
             max="100" 
             step="1" 
             [(ngModel)]="reduction" 
             (input)="onReductionInput($event)"
             [disabled]="!userService.isSuperAdmin()"
             [class.readonly]="!userService.isSuperAdmin()" />
    </div>
  </section>

  <!-- Tableau -->
  <section class="panel">
    <h2 class="panel__title">Tableau des valeurs</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="sticky">Poste</th>
            <th *ngFor="let y of years">{{ y }}</th>
            <th>Baisse entre {{ startYear }} et {{ endYear }}</th>
            <th>Baisse annuelle requise</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of tableRows">
            <td class="sticky">{{ row.label }}</td>
            <td *ngFor="let v of row.values" class="num">{{ v }}</td>
            <td class="num">{{ row.dropBetweenPct }}%</td>
            <td class="num">{{ row.annualRequiredPct }}%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ‚öôÔ∏è Bouton param√®tres avanc√©s entre tableau et graphique -->
  <div class="advanced-toggle">
    <button class="btn btn-advanced" (click)="toggleAdvancedMode()">
      {{ showAdvanced ? 'Masquer les param√®tres avanc√©s' : 'Param√®tres avanc√©s' }}
    </button>
  </div>

  <!-- Panneau avanc√© -->
  <section *ngIf="showAdvanced" class="panel advanced-panel">
    <div class="advanced-header">
      <h2 class="panel__title">Personnalisation des trajectoires par poste</h2>

      <div class="advanced-stats">
        <label class="lock-toggle">
          <input type="checkbox" 
                 [(ngModel)]="lockGlobal" 
                 (change)="saveSettingsPublic()"
                 [disabled]="!userService.isSuperAdmin()"
                 [class.readonly]="!userService.isSuperAdmin()" />
          üîí Verrouiller l'objectif global ({{ reduction }}%)
        </label>

        <div class="weighted-info">
          <span class="tag">R√©duction pond√©r√©e actuelle :</span>
          <strong>{{ weightedCurrentPct | number:'1.0-2' }}%</strong>
          <span class="tag">√âcart vs objectif :</span>
          <strong [class.bad]="weightedGapPct>0" [class.good]="weightedGapPct<=0">
            {{ weightedGapPct | number:'1.0-2' }} pts
          </strong>
        </div>

        <button class="btn btn-secondary" 
                (click)="resetPostes()"
                [disabled]="!userService.isSuperAdmin()"
                [class.readonly]="!userService.isSuperAdmin()">
          ‚Ü∫ R√©initialiser les postes
        </button>
      </div>
    </div>

    <div class="advanced-grid">
      <div class="poste-card" *ngFor="let p of postes">
        <div class="poste-card__head">
          <span class="poste-name">{{ p.nom }}</span>
          <span class="poste-badge">{{ p.reductionBasePct | number:'1.0-0' }}%</span>
        </div>
        <input type="range" 
               min="0" 
               max="100"
               [(ngModel)]="p.reductionBasePct"
               (input)="onPosteReductionChange(p.id)"
               [disabled]="!userService.isSuperAdmin()"
               [class.readonly]="!userService.isSuperAdmin()" />
      </div>
    </div>
  </section>

  <!-- Graphique -->
  <section class="panel">
    <h2 class="panel__title">Graphique de trajectoire</h2>
    <div class="chart-wrap">
      <canvas id="trajectory-chart"></canvas>
    </div>
  </section>

</div>

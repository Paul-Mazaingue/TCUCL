<!-- Bouton de retour -->
<div class="top-bar">
  <button class="back-button" (click)="goBackToDashboard()" mat-button>
    <mat-icon>arrow_back</mat-icon>
    Accueil
  </button>
</div>

<div class="params-container">
  <div class="params-row">
    <!-- Section: ParamÃ¨tres personnels -->
    <section class="card" data-title="ParamÃ¨tres personnels">
      <form #form="ngForm">
        <label>PrÃ©nom</label>
        <input type="text" [(ngModel)]="user.firstName" name="firstName">

        <label>Nom</label>
        <input type="text" [(ngModel)]="user.lastName" name="lastName">

        <label>Email</label>
        <input type="email" [(ngModel)]="user.email" name="email">

        <button type="button" (click)="updateInfo()" [disabled]="!user.firstName || !user.lastName || !user.email||
    !isEmailValid(user.email)" class="btn-update">
          Changer ses informations
        </button>
      </form>
    </section>

    <!-- Section: Changer son mot de passe -->
    <section class="card" data-title="Changer son mot de passe">
      <form #passwordForm="ngForm">
        <label>Email</label>
        <input type="email" [(ngModel)]="changePasswordData.email" name="emailPassword" required>

        <label>Ancien mot de passe</label>
        <div class="password-field">
          <input [type]="showOldPassword ? 'text' : 'password'" [(ngModel)]="changePasswordData.ancienMdp" name="ancienMdp" required>
          <button type="button" class="toggle-btn" (click)="toggleOldPasswordVisibility()" aria-label="Afficher ou masquer l'ancien mot de passe">
            {{ showOldPassword ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—¨' }}
          </button>
        </div>

        <label>Nouveau mot de passe</label>
        <div class="password-field">
          <input [type]="showNewPassword ? 'text' : 'password'" [(ngModel)]="changePasswordData.nouveauMdp" name="nouveauMdp" required>
          <button type="button" class="toggle-btn" (click)="toggleNewPasswordVisibility()" aria-label="Afficher ou masquer le nouveau mot de passe">
            {{ showNewPassword ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—¨' }}
          </button>
        </div>

        <button type="button" (click)="changePassword()"
                [disabled]="!changePasswordData.email || !changePasswordData.ancienMdp || !changePasswordData.nouveauMdp"
                class="btn-update">
          Changer le mot de passe
        </button>
      </form>
    </section>
    <!-- Grille des blocs params -->
    <div class="params-grid">
      <!-- Section: Admin-->
      <div *ngIf="isAdmin()" class="params-row">
        <!-- Ajouter un utilisateur -->
        <section class="card" data-title="Ajouter un utilisateur">
          <form #form="ngForm">
            <label>PrÃ©nom</label>
            <input type="text" placeholder="PrÃ©nom" [(ngModel)]="userToAdd.prenom" name="adminFirstName">

            <label>Nom</label>
            <input type="text" placeholder="Nom" [(ngModel)]="userToAdd.nom" name="adminLastName">

            <label>Email</label>
            <input type="email" placeholder="Email" [(ngModel)]="userToAdd.email" name="adminEmail">

            <div class="checkbox-line">
              <input type="checkbox" id="adminCheckbox" [(ngModel)]="userToAdd.estAdmin" name="adminIsAdmin">
              <label for="adminCheckbox">Utilisateur avec rÃ´le "Admin"</label>
            </div>
          </form>
          <button type="button" (click)="addUser()"
                  [disabled]="!userToAdd.prenom || !userToAdd.nom || !userToAdd.email || !isEmailValid(userToAdd.email)"
                  class="btn-update">
            Ajouter l'utilisateur
          </button>
        </section>

        <!-- Gestion des utilisateurs Admin-->
        <section class="card" data-title="Gestion des utilisateurs">
          <table *ngIf="utilisateursEntiteSelectionnee.length > 0" class="user-table">
            <thead>
            <tr>
              <th>Nom</th>
              <th>PrÃ©nom</th>
              <th>Admin</th>
              <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let user of utilisateursEntiteSelectionnee">
              <td>{{ user.nom }}</td>
              <td>{{ user.prenom }}</td>
              <td>
                <input type="checkbox" [checked]="user.estAdmin" (change)="onToggleAdmin(user)"
                       [disabled]="!isAdmin || !isSuperAdmin"/>
              </td>
              <td>
                <button title="Supprimer" (click)="deleterUser(user.id)">ğŸ—‘ï¸</button>
              </td>
            </tr>
            </tbody>
          </table>
        </section>
      </div>
    </div>
    <!-- Section: Super Admin-->
    <div *ngIf="isSuperAdmin()" class="params-row">
      <!-- Section: CrÃ©er une entitÃ© -->
      <section class="card" data-title="CrÃ©er une entitÃ©">
        <form #form="ngForm">

          <p class="section-info">ParamÃ¨tres de l'entitÃ©</p>

          <label>Nom</label>
          <input type="text" [(ngModel)]="entityToCreate.name" name="entityNameCreate">

          <label>Type</label>
          <select [(ngModel)]="entityToCreate.type" name="entityTypeCreate">
            <option>Enseignement SupÃ©rieur</option>
            <option>CollectivitÃ©</option>
          </select>

          <p class="section-info">Profil du premier admin de l'entitÃ©</p>

          <label>PrÃ©nom</label>
          <input type="text" placeholder="PrÃ©nom" [(ngModel)]="entityToCreate.admin.firstName"
                 name="adminFirstNameCreate">

          <label>Nom</label>
          <input type="text" placeholder="Nom" [(ngModel)]="entityToCreate.admin.lastName" name="adminLastName">

          <label>Email</label>
          <input type="email" placeholder="Email" [(ngModel)]="entityToCreate.admin.email" name="adminEmail">

          <button type="button" (click)="createEntity()"
                  [disabled]="!entityToCreate.name || !entityToCreate.type || !entityToCreate.admin.firstName || !entityToCreate.admin.lastName || !isEmailValid(entityToCreate.admin.email)"
                  class="btn-update">CrÃ©er l'entitÃ©
          </button>
        </form>
      </section>
      <!-- Section: Ajouter un utilisateur Super Admin-->
      <section class="card" data-title="Ajouter un utilisateur Ã  une entitÃ©">
        <form #form="ngForm">
          <label>SÃ©lectionner l'entitÃ©</label>
          <select [(ngModel)]="selectedEntity" name="selectedEntity" (ngModelChange)="onEntityChange($event)">
            <option *ngFor="let e of entitiesList" [value]="e.id">{{ e.nom }}</option>
          </select>

          <label>PrÃ©nom</label>
          <input type="text" placeholder="PrÃ©nom" [(ngModel)]="userToAdd.prenom" name="adminFirstName">

          <label>Nom</label>
          <input type="text" placeholder="Nom" [(ngModel)]="userToAdd.nom" name="adminLastName">

          <label>Email</label>
          <input type="email" placeholder="Email" [(ngModel)]="userToAdd.email" name="adminEmail">

          <div class="checkbox-line">
            <input type="checkbox" id="adminCheckbox" [(ngModel)]="userToAdd.estAdmin" name="adminIsAdmin">
            <label for="adminCheckbox">Utilisateur avec rÃ´le "Admin"</label>
          </div>

        </form>
        <button type="button" (click)="addUser()"
                [disabled]="!selectedEntity || !userToAdd.prenom || !userToAdd.nom || !userToAdd.email || !isEmailValid(userToAdd.email)"
                class="btn-update">
          Ajouter l'utilisateur
        </button>
      </section>

      <!-- Section: Gestion des utilisateurs Super Admin-->
      <section class="card" data-title="Gestion des utilisateurs">
        <label>EntitÃ© :</label>
        <select [(ngModel)]="selectedEntity" name="selectedEntity" (ngModelChange)="onEntityChange($event)">
          <option *ngFor="let e of entitiesList" [value]="e.id">{{ e.nom }}</option>
        </select>

        <table class="user-table">
          <thead>
          <tr>
            <th>Nom</th>
            <th>PrÃ©nom</th>
            <th>Admin</th>
            <th>Action</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let user of utilisateursEntiteSelectionnee">
            <td>{{ user.nom }}</td>
            <td>{{ user.prenom }}</td>
            <td>
              <input type="checkbox" [checked]="user.estAdmin" (change)="onToggleAdmin(user)"
                     [disabled]="!isAdmin || !isSuperAdmin"/>
            </td>
            <td>
              <button title="Supprimer" (click)="deleterUser(user.id)">ğŸ—‘ï¸</button>
            </td>
          </tr>
          </tbody>
        </table>
      </section>
      <section class="card" data-title="Facteurs d'Ã©missions">
        <label for="fileInput">Importer le fichier excel des facteurs d'Ã©missions :</label>
        <div style="display: flex; flex-direction: column; align-items: start; gap: 0.5rem; margin-top: 0.5rem;">
          <input type="file" id="fileInput" (change)="onFileSelected($event)">
          <button (click)="importFile()">Importer</button>
        </div>
      </section>
    </div>
  </div>
</div>
